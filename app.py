import streamlit as st
import os
from dotenv import load_dotenv
from langchain_openai import ChatOpenAI
from langchain_core.messages import SystemMessage, HumanMessage, AIMessage

# .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€
load_dotenv()

# Streamlit Cloudã®å ´åˆã¯st.secretsã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
if "OPENAI_API_KEY" in st.secrets:
    os.environ["OPENAI_API_KEY"] = st.secrets["OPENAI_API_KEY"]

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(
    page_title="å°‚é–€å®¶AI ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª",
    page_icon="ğŸ¤–",
    layout="wide"
)


def generate_summary_email(messages: list) -> str:
    """
    ä¼šè©±å±¥æ­´ã‹ã‚‰ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«å½¢å¼ã®ã¾ã¨ã‚ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    
    Args:
        messages (list): ä¼šè©±å±¥æ­´ã®ãƒªã‚¹ãƒˆ
    
    Returns:
        str: ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«å½¢å¼ã®ã¾ã¨ã‚
    """
    llm = ChatOpenAI(model_name="gpt-4o", temperature=0)
    
    # ä¼šè©±å±¥æ­´ã‚’ãƒ†ã‚­ã‚¹ãƒˆã«å¤‰æ›
    conversation_text = ""
    for msg in messages:
        role = "è³ªå•" if msg["role"] == "user" else "å›ç­”"
        conversation_text += f"{role}: {msg['content']}\n\n"
    
    # ã‚µãƒãƒªãƒ¼ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    system_content = """ã‚ãªãŸã¯å„ªç§€ã§ä¸å¯§ãªå–¶æ¥­ãƒãƒ³ã§ã™ã€‚å’æ¥­ã‚¢ãƒ«ãƒãƒ åˆ¶ä½œæ¥­è€…ã¨ã—ã¦ã€å­¦æ ¡ã®å…ˆç”Ÿæ–¹ã¨ã‚„ã‚Šå–ã‚Šã‚’ã—ã¦ã„ã¾ã™ã€‚ãƒ“ã‚¸ãƒã‚¹ãƒãƒ³ã¨ã—ã¦ã®ãƒ«ãƒ¼ãƒ«ã‚„ãƒãƒŠãƒ¼ã«å‰‡ã‚Šã€è¦ªåˆ‡ä¸å¯§ã«ã€
ä»¥ä¸‹ã®ä¼šè©±å±¥æ­´ã®å†…å®¹ã‚’ã€1ã¤ã®ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«ã¨ã—ã¦åˆ†ã‹ã‚Šã‚„ã™ãã¾ã¨ã‚ã¦ãã ã•ã„ã€‚

ã€é‡è¦ãªæŒ‡ç¤ºã€‘
- æ›¸ãå‡ºã—ã¯å¿…ãšã€Œå¹³ç´ ã‚ˆã‚Šæ ¼åˆ¥ã®ã”é«˜é…ã‚’è³œã‚Šåšãå¾¡ç¤¼ç”³ã—ä¸Šã’ã¾ã™ã€‚ã€ã‹ã‚‰å§‹ã‚ã‚‹
- ä¼šè©±ã®å†…å®¹ã‚’è«–ç†çš„ã«æ•´ç†ã—ã€ãƒ“ã‚¸ãƒã‚¹æ–‡æ›¸ã¨ã—ã¦é©åˆ‡ãªå½¢å¼ã«ã™ã‚‹
- æ•¬èªã‚’é©åˆ‡ã«ä½¿ç”¨ã—ã€ä¸å¯§ã§åˆ†ã‹ã‚Šã‚„ã™ã„è¡¨ç¾ã‚’ä½¿ã†
- é©åˆ‡ãªæ®µè½åˆ†ã‘ã¨ç®‡æ¡æ›¸ãã‚’ä½¿ç”¨ã—ã¦èª­ã¿ã‚„ã™ãã™ã‚‹
- å‚¬ä¿ƒã‚„å¦å®šã‚’ã™ã‚‹å ´åˆã¯ã€å¿…ãšå…ˆç”Ÿæ–¹ã‚’æƒ³ã£ãŸè¡¨ç¾ã«ã™ã‚‹
  ä¾‹ï¼šã€Œå’æ¥­ã‚¢ãƒ«ãƒãƒ ä½œæˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®éƒ½åˆä¸Šã€ï½ã‚’ã§ãã‚‹ã ã‘æ—©ã‚ã«ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€
  ä¾‹ï¼šã€Œã“ã‚Œä»¥ä¸Šé…ããªã£ã¦ã—ã¾ã„ã¾ã™ã¨ã€æ ¡æ­£é–²è¦§æ™‚é–“ãŒçŸ­ããªã‚‹ãªã©ã€å…ˆç”Ÿæ–¹ã«ã¨ã£ã¦ãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒå¤§ãããªã£ã¦ã—ã¾ã†ãŸã‚ã€
- å¸¸ã«å…ˆç”Ÿæ–¹ã®ç«‹å ´ã«ç«‹ã¡ã€å…ˆç”Ÿæ–¹ã®ãŸã‚ã¨ã„ã†å§¿å‹¢ã‚’æ˜ç¢ºã«ã™ã‚‹
- æœ€å¾Œã¯é©åˆ‡ãªç· ã‚ã®è¨€è‘‰ã§çµ‚ã‚ã‚‹
- ãƒ¡ãƒ¼ãƒ«ã®æœ€å¾Œã«ä»¥ä¸‹ã®ç½²åã‚’å¿…ãšè¿½åŠ ã™ã‚‹ï¼š

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ ªå¼ä¼šç¤¾éšˆå·å†™çœŸé¤¨
æ‹…å½“ï¼šéšˆå·
TEL: 049-251-0476
Email: h@kumakawa.co.jp
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"""
    
    messages_for_llm = [
        SystemMessage(content=system_content),
        HumanMessage(content=f"ä»¥ä¸‹ã®ä¼šè©±å±¥æ­´ã‚’ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«ã¨ã—ã¦ã¾ã¨ã‚ã¦ãã ã•ã„:\n\n{conversation_text}")
    ]
    
    result = llm.invoke(messages_for_llm)
    return result.content


def get_llm_response(user_input: str, expert_type: str, chat_history: list) -> str:
    """
    å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã¨å°‚é–€å®¶ã‚¿ã‚¤ãƒ—ã€ä¼šè©±å±¥æ­´ã‚’å—ã‘å–ã‚Šã€LLMã‹ã‚‰ã®å›ç­”ã‚’è¿”ã™é–¢æ•°
    
    Args:
        user_input (str): ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ
        expert_type (str): å°‚é–€å®¶ã®ã‚¿ã‚¤ãƒ—ï¼ˆ"business" ã¾ãŸã¯ "law"ï¼‰
        chat_history (list): ä¼šè©±å±¥æ­´ã®ãƒªã‚¹ãƒˆ
    
    Returns:
        str: LLMã‹ã‚‰ã®å›ç­”
    """
    # LLMãƒ¢ãƒ‡ãƒ«ã®åˆæœŸåŒ–ï¼ˆGPT-4oã‚’ä½¿ç”¨ï¼‰
    llm = ChatOpenAI(model_name="gpt-4o", temperature=0)
    
    # å°‚é–€å®¶ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
    if expert_type == "business":
        system_content = """ã‚ãªãŸã¯å„ªç§€ã§ä¸å¯§ãªå–¶æ¥­ãƒãƒ³ã§ã™ã€‚æ ªå¼ä¼šç¤¾éšˆå·å†™çœŸé¤¨ã®æ‹…å½“è€…ã€Œéšˆå·ã€ã¨ã—ã¦ã€å’æ¥­ã‚¢ãƒ«ãƒãƒ åˆ¶ä½œæ¥­è€…ã¨ã—ã¦å­¦æ ¡ã®å…ˆç”Ÿæ–¹ã¨ã‚„ã‚Šå–ã‚Šã‚’ã—ã¦ã„ã¾ã™ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ä¸ãˆã‚‰ã‚ŒãŸæ–‡ç« ã‚’ãƒ“ã‚¸ãƒã‚¹æ–‡æ›¸ã¨ã—ã¦æ•´ãˆã€èª­ã¿ã‚„ã™ãæ´—ç·´ã•ã‚ŒãŸæ–‡ç« ã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚

ã€é‡è¦ãªæŒ‡ç¤ºã€‘
- æ–‡ç« ã®è©±è€…ï¼ˆæ›¸ãæ‰‹ï¼‰ã¯å¸¸ã«ã€Œéšˆå·ã€ã¨ã—ã€ä¸€äººç§°ã§æ›¸ã
- ã€Œç§ã€ã‚„ã€Œå¼Šç¤¾ã€ã¨ã„ã†è¡¨ç¾ã‚’ä½¿ã†å ´åˆã‚‚ã€æ–‡è„ˆã‹ã‚‰ã€Œéšˆå·ã€ãŒæ›¸ã„ã¦ã„ã‚‹ã“ã¨ãŒæ˜ç¢ºã«ã‚ã‹ã‚‹ã‚ˆã†ã«ã™ã‚‹
- æ•¬èªã‚’é©åˆ‡ã«ä½¿ç”¨ã—ã€ãƒ“ã‚¸ãƒã‚¹ã‚·ãƒ¼ãƒ³ã§ä½¿ãˆã‚‹ä¸å¯§ã§åˆ†ã‹ã‚Šã‚„ã™ã„è¡¨ç¾ã«ã™ã‚‹
- å‚¬ä¿ƒã‚„å¦å®šã‚’ã™ã‚‹å ´åˆã¯ã€ç›¸æ‰‹ï¼ˆå…ˆç”Ÿæ–¹ï¼‰ã‚’æƒ³ã£ãŸè¡¨ç¾ã‚’ä½¿ç”¨ã™ã‚‹
- å‚¬ä¿ƒã®ä¾‹ï¼šã€Œå’æ¥­ã‚¢ãƒ«ãƒãƒ ä½œæˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®éƒ½åˆä¸Šã€â—‹æœˆâ—‹æ—¥ã¾ã§ã«ã”ç¢ºèªã„ãŸã ãå¿…è¦ãŒã”ã–ã„ã¾ã™ã€
- ãƒ‡ãƒ¡ãƒªãƒƒãƒˆèª¬æ˜ã®ä¾‹ï¼šã€Œã“ã‚Œä»¥ä¸ŠãŠæ™‚é–“ã‚’ã„ãŸã ãã¾ã™ã¨ã€æ ¡æ­£é–²è¦§æ™‚é–“ãŒçŸ­ããªã‚‹ãªã©ã€å…ˆç”Ÿæ–¹ã«ã¨ã£ã¦ãƒ‡ãƒ¡ãƒªãƒƒãƒˆãŒå¤§ãããªã£ã¦ã—ã¾ã†ãŸã‚ã€
- å¸¸ã«å…ˆç”Ÿæ–¹ã®ç«‹å ´ã«ç«‹ã¡ã€å…ˆç”Ÿæ–¹ã®åˆ©ç›Šã‚„ãƒ¡ãƒªãƒƒãƒˆã‚’è€ƒæ…®ã—ãŸæ–‡ç« æ§‹æˆã«ã™ã‚‹
- å‚¬ä¿ƒã‚„å¦å®šã‚‚ã€ã‚ãã¾ã§å…ˆç”Ÿæ–¹ã®ãŸã‚ã¨ã„ã†å§¿å‹¢ã‚’æ˜ç¢ºã«ã™ã‚‹
- ç›¸æ‰‹ã¸ã®é…æ…®ã¨æ•¬æ„ã‚’å¿˜ã‚Œãšã€ä¸å¯§ã§ã‚ã‚ŠãªãŒã‚‰è¦ç‚¹ã‚’æ˜ç¢ºã«ä¼ãˆã‚‹"""
    elif expert_type == "concierge":
        system_content = """ã‚ãªãŸã¯æ ªå¼ä¼šç¤¾éšˆå·å†™çœŸé¤¨ã®å„ªç§€ãªã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ã§ã™ã€‚ãŠå®¢æ§˜ã®ã”è³ªå•ã«å¯¾ã—ã¦ã€å½“é¤¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚„æƒ…å ±ã‚’åŸºã«ä¸å¯§ã«ãŠç­”ãˆã—ã¾ã™ã€‚

ã€éšˆå·å†™çœŸé¤¨ã®æƒ…å ±ã€‘

â–  åŸºæœ¬æƒ…å ±
- 1940å¹´å‰µæ¥­ã®æ­´å²ã‚ã‚‹å†™çœŸé¤¨
- æ‰€åœ¨åœ°ï¼šåŸ¼ç‰çœŒå¯Œå£«è¦‹å¸‚é¶´ç€¬æ±1-8-20
- é›»è©±ï¼š049-251-0476
- å–¶æ¥­æ™‚é–“ï¼š10:00ï½18:00
- å®šä¼‘æ—¥ï¼šæœ¨æ›œæ—¥
- Webã‚µã‚¤ãƒˆï¼šhttps://kumakawa.co.jp ã€ https://kumakawa.co.jp/satellite/

â–  æ’®å½±ãƒ¡ãƒ‹ãƒ¥ãƒ¼
- ãƒ™ãƒ“ãƒ¼ã‚¢ãƒ«ãƒãƒ 
- ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¢ãƒ«ãƒãƒ 
- ãŠèª•ç”Ÿæ—¥è¨˜å¿µ
- å®¶æ—å†™çœŸãƒ»çµå©šè¨˜å¿µ
- ãŠå®®å‚ã‚Š
- åˆç¯€å¥
- å…¥åœ’ãƒ»å…¥å­¦
- ä¸ƒäº”ä¸‰
- å’åœ’ãƒ»å’æ¥­
- æˆäººå¼
- è¨¼æ˜å†™çœŸï¼ˆé€šå¸¸ãƒ»ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ»ã‚ªãƒ¼ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ãƒ•ã‚©ãƒˆï¼‰
- å­¦æ ¡ã‚¹ãƒŠãƒƒãƒ—å†™çœŸ
- å’æ¥­ã‚¢ãƒ«ãƒãƒ åˆ¶ä½œ

â–  æ’®å½±ã®æµã‚Œ
1. ã”äºˆç´„ï¼šå®Œå…¨äºˆç´„åˆ¶ï¼ˆæˆäººã®æ—¥ã®ã¿ã”æ¥é¤¨é †ï¼‰
2. è¡£è£…é¸ã³ï¼šä¸ƒäº”ä¸‰ã€æˆäººç”·æ€§è¢´ã€å’æ¥­è¢´ã¯æ’®å½±æ—¥å‰ã«é¸ã¶
3. æ’®å½±ï¼š5åˆ†ï½30åˆ†ï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³ã‚¢ãƒ«ãƒãƒ ã¯1æ™‚é–“å¼±ï¼‰
4. ã§ãã‚ãŒã‚Šï¼šç´„1ãƒ¶æœˆå¾Œï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³ã‚¢ãƒ«ãƒãƒ ã¯ç´„6é€±é–“å¾Œï¼‰

â–  ç‰¹å¾´
- ã‚¢ãƒƒãƒˆãƒ›ãƒ¼ãƒ ãªé›°å›²æ°—ã§æ’®å½±
- ãŠå­æ§˜ç›®ç·šã®é›°å›²æ°—ä½œã‚Š
- è±Šå¯Œãªãƒ¬ãƒ³ã‚¿ãƒ«è¡£è£…
- é§è»Šå ´ã‚ã‚Šï¼ˆé€šå¸¸2å°ã€ç¹å¿™æœŸ4å°ï¼‰
- ç¾é‡‘ãƒ»ã‚«ãƒ¼ãƒ‰ãƒ»é›»å­ãƒãƒãƒ¼æ±ºæ¸ˆå¯èƒ½
- ãƒ‡ãƒ¼ã‚¿è²©å£²ã‚ã‚Š
- æºå¸¯å¾…å—ç”»åƒãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ

â–  ã‚¢ãƒ«ãƒãƒ ä¼šå“¡
- ç™»éŒ²æœˆã«æ’®å½±ã€30ï¼…ï½10ï¼…OFF

â–  ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼
- ä½“èª¿ä¸è‰¯ç­‰ã®ã‚„ã‚€ã‚’å¾—ãªã„ç†ç”±ï¼šãŠæ—¥ã«ã¡å¤‰æ›´1å›ã¾ã§ç„¡æ–™
- ç¾å®¹å¸«æ‰‹é…æ¸ˆã¿ã®å ´åˆï¼š1ãƒ¶æœˆå‰ã‹ã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™20ï¼…ï½100ï¼…
- å¤©æ°—ã‚„è‡ªå·±éƒ½åˆã«ã‚ˆã‚‹ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«æ–™ã‚ã‚Š

ã€å›ç­”ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã€‘
- ä¸Šè¨˜ã®æƒ…å ±ã‚’åŸºã«ã€ãŠå®¢æ§˜ã®è³ªå•ã«æ­£ç¢ºã«ãŠç­”ãˆã™ã‚‹
- ä¸å¯§ã§è¦ªã—ã¿ã‚„ã™ã„è¨€è‘‰é£ã„ã‚’ä½¿ã†
- è©³ç´°æƒ…å ±ãŒå¿…è¦ãªå ´åˆã¯ã€Webã‚µã‚¤ãƒˆã‚„ãŠé›»è©±ã§ã®ãŠå•ã„åˆã‚ã›ã‚’ã”æ¡ˆå†…ã™ã‚‹
- ãŠå®¢æ§˜ã®ãƒ‹ãƒ¼ã‚ºã«åˆã‚ã›ã¦æœ€é©ãªãƒ—ãƒ©ãƒ³ã‚’ææ¡ˆã™ã‚‹
- å¸¸ã«ãŠå®¢æ§˜ç›®ç·šã§ã€è¦ªèº«ã«å¯¾å¿œã™ã‚‹"""
    elif expert_type == "law":
        system_content = "ã‚ãªãŸã¯æ—¥æœ¬ã®æ³•å¾‹ã®å°‚é–€å®¶ã§ã™ã€‚æ—¥æœ¬ã®æ³•å¾‹ã€æ³•è¦åˆ¶ã€æ³•çš„æ‰‹ç¶šããªã©ã«é–¢ã™ã‚‹è³ªå•ã«å°‚é–€çš„ãªçŸ¥è­˜ã‚’æŒã£ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚"
    elif expert_type == "legal_check":
        system_content = """ã‚ãªãŸã¯æ—¥æœ¬ã®æ³•å¾‹ã«è©³ã—ã„ãƒªãƒ¼ã‚¬ãƒ«ãƒã‚§ãƒƒã‚¯ã®å°‚é–€å®¶ã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ä¸ãˆã‚‰ã‚ŒãŸæ–‡æ›¸ã‚„å¥‘ç´„æ›¸ã€è¦ç´„ã€åˆ©ç”¨è¦ç´„ãªã©ã®æ³•çš„å¦ƒå½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€æ”¹å–„æ¡ˆã‚’æä¾›ã—ã¾ã™ã€‚

ã€ãƒã‚§ãƒƒã‚¯é …ç›®ã€‘
- æ³•ä»¤é•åã®æœ‰ç„¡
- ä¸å½“æ¡é …ã®æœ‰ç„¡
- æ¶ˆè²»è€…å¥‘ç´„æ³•ã€ç‰¹å®šå•†å–å¼•æ³•ã€å€‹äººæƒ…å ±ä¿è­·æ³•ãªã©ã¸ã®é©åˆæ€§
- æ›–æ˜§ãªè¡¨ç¾ã‚„èª¤è§£ã‚’æ‹›ãå¯èƒ½æ€§ã®ã‚ã‚‹è¨˜è¿°
- ãƒªã‚¹ã‚¯ã®ã‚ã‚‹æ¡é …

ã€å›ç­”å½¢å¼ã€‘
å¿…ãšä»¥ä¸‹ã®å½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š

## ãƒªãƒ¼ã‚¬ãƒ«ãƒã‚§ãƒƒã‚¯çµæœ

### ç·åˆè©•ä¾¡
[é©æ³• / è¦æ³¨æ„ / å•é¡Œã‚ã‚Š] ã®ã„ãšã‚Œã‹ã‚’æ˜è¨˜

### å•é¡Œç‚¹
1. [å•é¡Œç‚¹ã®è©³ç´°]
2. [å•é¡Œç‚¹ã®è©³ç´°]
ï¼ˆå•é¡ŒãŒãªã„å ´åˆã¯ã€Œç‰¹ã«å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€ã¨è¨˜è¼‰ï¼‰

### æ”¹å–„ææ¡ˆ
[æ”¹å–„ãŒå¿…è¦ãªå ´åˆã®ã¿ã€å…·ä½“çš„ãªæ”¹å–„æ¡ˆã‚’è¨˜è¼‰]

---
## æ”¹å–„å¾Œã®æ–‡æ›¸

[æ”¹å–„ãŒå¿…è¦ãªå ´åˆã€ä¿®æ­£å¾Œã®å…¨æ–‡ã‚’è¨˜è¼‰]
[æ”¹å–„ãŒä¸è¦ãªå ´åˆã¯ã€ŒåŸæ–‡ã®ã¾ã¾ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€ã¨è¨˜è¼‰]

---

â€» ã“ã®ãƒã‚§ãƒƒã‚¯ã¯ä¸€èˆ¬çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã§ã‚ã‚Šã€æœ€çµ‚çš„ãªæ³•çš„åˆ¤æ–­ã¯å¼è­·å£«ã«ã”ç›¸è«‡ãã ã•ã„ã€‚"""
    else:
        system_content = "You are a helpful assistant."
    
    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½œæˆï¼ˆã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + ä¼šè©±å±¥æ­´ + æ–°ã—ã„è³ªå•ï¼‰
    messages = [SystemMessage(content=system_content)]
    
    # ä¼šè©±å±¥æ­´ã‚’è¿½åŠ 
    messages.extend(chat_history)
    
    # æ–°ã—ã„è³ªå•ã‚’è¿½åŠ 
    messages.append(HumanMessage(content=user_input))
    
    # LLMã«å•ã„åˆã‚ã›
    result = llm.invoke(messages)
    
    return result.content


def main():
    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒˆãƒ«
    st.title("ğŸ¤– å°‚é–€å®¶AI ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒª")
    
    # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èª¬æ˜
    st.markdown("""
    ## ğŸ“‹ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¦‚è¦
    ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€å°‚é–€åˆ†é‡ã«ç‰¹åŒ–ã—ãŸAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã¨å¯¾è©±ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
    LangChainã¨OpenAIã®GPT-4oãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã€é¸æŠã—ãŸå°‚é–€å®¶ã¨ã—ã¦å›ç­”ã—ã¾ã™ã€‚
    ä¼šè©±å±¥æ­´ã‚’ä¿æŒã™ã‚‹ãŸã‚ã€å‰ã®è³ªå•ã‚’æ·±æ˜ã‚Šã—ãŸè³ªå•ã‚‚å¯èƒ½ã§ã™ã€‚
    
    ## ğŸ”§ æ“ä½œæ–¹æ³•
    1. **å°‚é–€å®¶ã‚’é¸æŠ**: ä¸‹ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‹ã‚‰ç›¸è«‡ã—ãŸã„å°‚é–€å®¶ã‚’é¸æŠã—ã¦ãã ã•ã„
    2. **è³ªå•ã‚’å…¥åŠ›**: ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«è³ªå•ã‚„ç›¸è«‡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
    3. **é€ä¿¡**: ã€Œé€ä¿¡ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€é¸æŠã—ãŸå°‚é–€å®¶ã¨ã—ã¦AIãŒå›ç­”ã—ã¾ã™
    4. **ä¼šè©±å±¥æ­´**: éå»ã®ä¼šè©±ã¯ä¿æŒã•ã‚Œã€ç¶šã‘ã¦è³ªå•ã§ãã¾ã™
    5. **ãƒªã‚»ãƒƒãƒˆ**: ã€Œä¼šè©±ã‚’ãƒªã‚»ãƒƒãƒˆã€ãƒœã‚¿ãƒ³ã§ä¼šè©±å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã§ãã¾ã™
    
    ### åˆ©ç”¨å¯èƒ½ãªå°‚é–€å®¶
    - **å„ªç§€ã§ä¸å¯§ãªå–¶æ¥­ãƒãƒ³**: ä¸ãˆã‚‰ã‚ŒãŸæ–‡ç« ã‚’ãƒ“ã‚¸ãƒã‚¹æ–‡æ›¸ã¨ã—ã¦æ•´ãˆã€èª­ã¿ã‚„ã™ãæ´—ç·´ã•ã‚ŒãŸæ–‡ç« ã«å¤‰æ›
    - **éšˆå·å†™çœŸé¤¨ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥**: éšˆå·å†™çœŸé¤¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã€æ–™é‡‘ã€æ’®å½±ã®æµã‚Œãªã©ã«ã¤ã„ã¦å›ç­”
    - **æ—¥æœ¬ã®æ³•å¾‹ã®å°‚é–€å®¶**: æ—¥æœ¬ã®æ³•å¾‹ã€æ³•è¦åˆ¶ã€æ³•çš„æ‰‹ç¶šããªã©ã«é–¢ã™ã‚‹è³ªå•ã«å›ç­”
    - **ãƒªãƒ¼ã‚¬ãƒ«ãƒã‚§ãƒƒã‚¯**: æ–‡æ›¸ã®æ³•çš„å¦ƒå½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€æ”¹å–„å¾Œã®æ–‡æ›¸ã‚’ç”Ÿæˆ
    """)
    
    st.divider()
    
    # ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®åˆæœŸåŒ–
    if "chat_history" not in st.session_state:
        st.session_state.chat_history = []
    if "messages" not in st.session_state:
        st.session_state.messages = []
    
    # ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«å°‚é–€å®¶é¸æŠã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’é…ç½®
    st.sidebar.header("å°‚é–€å®¶ã®é¸æŠ")
    expert_type = st.sidebar.radio(
        "ç›¸è«‡ã—ãŸã„å°‚é–€å®¶ã‚’é¸æŠã—ã¦ãã ã•ã„:",
        options=["business", "concierge", "law", "legal_check"],
        format_func=lambda x: "ğŸ’¼ å„ªç§€ã§ä¸å¯§ãªå–¶æ¥­ãƒãƒ³" if x == "business" else ("ğŸª éšˆå·å†™çœŸé¤¨ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥" if x == "concierge" else ("âš–ï¸ æ—¥æœ¬ã®æ³•å¾‹ã®å°‚é–€å®¶" if x == "law" else "ğŸ“ ãƒªãƒ¼ã‚¬ãƒ«ãƒã‚§ãƒƒã‚¯")),
        index=0
    )
    
    # é¸æŠã•ã‚ŒãŸå°‚é–€å®¶ã®è¡¨ç¤º
    if expert_type == "business":
        st.sidebar.success("ç¾åœ¨ã®å°‚é–€å®¶: å„ªç§€ã§ä¸å¯§ãªå–¶æ¥­ãƒãƒ³ ğŸ’¼")
        st.sidebar.info("æ–‡ç« ã‚’ãƒ“ã‚¸ãƒã‚¹æ–‡æ›¸ã¨ã—ã¦æ•´ãˆã€èª­ã¿ã‚„ã™ãæ´—ç·´ã•ã‚ŒãŸè¡¨ç¾ã«å¤‰æ›ã—ã¾ã™ã€‚")
    elif expert_type == "concierge":
        st.sidebar.success("ç¾åœ¨ã®å°‚é–€å®¶: éšˆå·å†™çœŸé¤¨ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ ğŸª")
        st.sidebar.info("éšˆå·å†™çœŸé¤¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚„æƒ…å ±ã«ã¤ã„ã¦ãŠç­”ãˆã—ã¾ã™ã€‚")
    elif expert_type == "law":
        st.sidebar.success("ç¾åœ¨ã®å°‚é–€å®¶: æ—¥æœ¬ã®æ³•å¾‹ã®å°‚é–€å®¶ âš–ï¸")
        st.sidebar.info("æ—¥æœ¬ã®æ³•å¾‹ã€æ³•è¦åˆ¶ã€æ³•çš„æ‰‹ç¶šããªã©ã«é–¢ã™ã‚‹è³ªå•ã«ãŠç­”ãˆã—ã¾ã™ã€‚")
    else:
        st.sidebar.success("ç¾åœ¨ã®å°‚é–€å®¶: ãƒªãƒ¼ã‚¬ãƒ«ãƒã‚§ãƒƒã‚¯ ğŸ“")
        st.sidebar.info("æ–‡æ›¸ã®æ³•çš„å¦ƒå½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€æ”¹å–„æ¡ˆã‚’æä¾›ã—ã¾ã™ã€‚")
    
    # ä¼šè©±å±¥æ­´ã®ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
    st.sidebar.divider()
    if st.sidebar.button("ğŸ”„ ä¼šè©±ã‚’ãƒªã‚»ãƒƒãƒˆ", use_container_width=True):
        st.session_state.chat_history = []
        st.session_state.messages = []
        st.rerun()
    
    # å–¶æ¥­ãƒãƒ³é¸æŠæ™‚ã®ã¾ã¨ã‚ç”Ÿæˆãƒœã‚¿ãƒ³
    if expert_type == "business" and len(st.session_state.messages) > 0:
        st.sidebar.divider()
        if st.sidebar.button("ğŸ“§ ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«ã¨ã—ã¦ã¾ã¨ã‚ã‚‹", type="primary", use_container_width=True):
            with st.spinner("ğŸ“ ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«ã‚’ç”Ÿæˆä¸­..."):
                try:
                    summary_email = generate_summary_email(st.session_state.messages)
                    st.session_state.summary_email = summary_email
                except Exception as e:
                    st.sidebar.error(f"ã‚¨ãƒ©ãƒ¼: {str(e)}")
    
    # ä¼šè©±å±¥æ­´ã®è¡¨ç¤º
    st.sidebar.divider()
    st.sidebar.subheader("ğŸ“Š ä¼šè©±çµ±è¨ˆ")
    st.sidebar.metric("ä¼šè©±ã®ã‚„ã‚Šå–ã‚Šæ•°", len(st.session_state.messages) // 2)
    
    # ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢
    st.header("ğŸ’¬ ä¼šè©±")
    
    # ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«ã®ã¾ã¨ã‚ã‚’è¡¨ç¤ºï¼ˆç”Ÿæˆã•ã‚ŒãŸå ´åˆï¼‰
    if "summary_email" in st.session_state and st.session_state.summary_email:
        st.success("âœ… ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼")
        with st.expander("ğŸ“§ ç”Ÿæˆã•ã‚ŒãŸãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ«", expanded=True):
            st.markdown(st.session_state.summary_email)
            
            # ã‚³ãƒ”ãƒ¼ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢
            st.text_area(
                "ã‚³ãƒ”ãƒ¼ç”¨",
                st.session_state.summary_email,
                height=300,
                key="summary_copy"
            )
        
        # ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã¨ã¾ã¨ã‚ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚’æ¨ªä¸¦ã³ã«é…ç½®
        col1, col2 = st.columns(2)
        with col1:
            if st.button("ğŸ“‹ ã‚³ãƒ”ãƒ¼", use_container_width=True):
                st.toast("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼", icon="âœ…")
                # JavaScriptã‚’ä½¿ç”¨ã—ã¦ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                st.write(f"""
                <script>
                navigator.clipboard.writeText(`{st.session_state.summary_email.replace('`', '\\`')}`);
                </script>
                """, unsafe_allow_html=True)
        with col2:
            if st.button("âŒ ã¾ã¨ã‚ã‚’é–‰ã˜ã‚‹", use_container_width=True):
                del st.session_state.summary_email
                st.rerun()
        
        st.divider()
    
    # ä¼šè©±å±¥æ­´ã®è¡¨ç¤º
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])
    
    # å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
    user_input = st.chat_input("è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...")
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè³ªå•ã‚’é€ä¿¡ã—ãŸå ´åˆ
    if user_input:
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        with st.chat_message("user"):
            st.markdown(user_input)
        
        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã«è¿½åŠ 
        st.session_state.messages.append({"role": "user", "content": user_input})
        
        # AIã®å›ç­”ã‚’ç”Ÿæˆ
        with st.chat_message("assistant"):
            with st.spinner("ğŸ¤” è€ƒãˆä¸­..."):
                try:
                    # LLMã‹ã‚‰å›ç­”ã‚’å–å¾—
                    response = get_llm_response(user_input, expert_type, st.session_state.chat_history)
                    
                    # å›ç­”ã‚’è¡¨ç¤º
                    st.markdown(response)
                    
                    # ãƒªãƒ¼ã‚¬ãƒ«ãƒã‚§ãƒƒã‚¯ã®å ´åˆã€æ”¹å–„å¾Œã®æ–‡æ›¸ã‚’æŠ½å‡ºã—ã¦ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                    if expert_type == "legal_check" and "## æ”¹å–„å¾Œã®æ–‡æ›¸" in response:
                        # æ”¹å–„å¾Œã®æ–‡æ›¸ã‚’æŠ½å‡º
                        parts = response.split("## æ”¹å–„å¾Œã®æ–‡æ›¸")
                        if len(parts) > 1:
                            improved_text = parts[1].split("---")[0].strip()
                            if improved_text and "åŸæ–‡ã®ã¾ã¾ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“" not in improved_text:
                                st.divider()
                                st.subheader("ğŸ“‹ æ”¹å–„å¾Œã®æ–‡æ›¸ã‚’ã‚³ãƒ”ãƒ¼")
                                col1, col2 = st.columns([5, 1])
                                with col1:
                                    st.text_area(
                                        "æ”¹å–„å¾Œã®æ–‡æ›¸",
                                        improved_text,
                                        height=200,
                                        key=f"improved_text_{len(st.session_state.messages)}"
                                    )
                                with col2:
                                    st.write("")
                                    st.write("")
                                    if st.button("ğŸ“‹ ã‚³ãƒ”ãƒ¼", key=f"copy_btn_{len(st.session_state.messages)}", use_container_width=True):
                                        st.toast("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼", icon="âœ…")
                                        st.write(f"""
                                        <script>
                                        navigator.clipboard.writeText(`{improved_text.replace('`', '\\`')}`);
                                        </script>
                                        """, unsafe_allow_html=True)
                    
                    # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã«è¿½åŠ 
                    st.session_state.messages.append({"role": "assistant", "content": response})
                    
                    # ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«è¿½åŠ ï¼ˆLangChainã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å½¢å¼ï¼‰
                    st.session_state.chat_history.append(HumanMessage(content=user_input))
                    st.session_state.chat_history.append(AIMessage(content=response))
                    
                except Exception as e:
                    error_msg = f"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"
                    st.error(error_msg)
                    st.info("OpenAI APIã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
    
    # ãƒ•ãƒƒã‚¿ãƒ¼
    st.divider()
    st.caption("Powered by LangChain and OpenAI GPT-4o")


if __name__ == "__main__":
    main()
